---
title: "Wine Review Project"
author: "Armistead, Vanessa; Pricken, Luisa; Roes, Bart; Rouatbi Ameni"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  html_document:
    theme: cerulean
    highlight: tango 
bibliography: Bibliography.bib
---

```{r setup}
# This is the chunck indicates all of the different packages used in our project
library("leaflet")
library("geojsonio")
library("readr")
library("data.table")
library("purrr")
library("geonames")
library("tidyverse")
```

## Introduction 
We decided to work on a wine data review that was available on kaggle. This 
dataset contains information that can be found on the website
"Wine Enthousiast". We created an interactive map that is easy to navigate
through the different countries of the World. Indeed, one is able to see the
best wine of each country. One can change the variety of the wine to see which 
country of the World has the best wine of this specific variety. 

## Data Cleaning

#### Wine Review Dataset
The original dataset from kaggle contained 14 variables including: 
- X: this integer variable indicates the observation number
- Country: this variable shows from which country the wine comes from. It is 
of type character 
- Description: this variable of type character gives us information about the 
wine
- Designation: it indicates the vineyard of the winery. It is of type character
- Points: this interger variable contains the number of points that was given 
to the specific wine. The scale is between 1 and 100 where 100 indicates a good
wine
- Price: it indicates the cost of the different bottles of wine which is in 
US$. It is a numerical variable
- Province: this character variable shows from which province/state the wine
is from
- Region 1: it indicates the area of where the wine is from. It is of type
character
- Region 2: this character variables adds information about the region of the
wine
- Taster Name: character variable indicating the name of the taster of the wine
that posted the review on the website Wine Enthousiast
- Taster Twitter Handle: this character variables includes information about 
the Twitter account of the taster of the wine
- Title: it is a character variable that contains information about the wine 
such as the type of wine and the year of the wine
- Variety: this character variable indicates the grapes used for the wine for
instance "Pinot Gris"
- Winery: it is a character variable indicating which winery produced the wine

This dataset contains 129971 observations.

We then deleted the unnecessary variables, i.e. the X, the Taster Name, and the 
Taster Twitter Handle. Moreover, we deleted the rows containing missing
information about the price, the region 1 and the number of points. We aslo 
added a column "Year" which extracts information of the year from the "Title" 
variable. 
```{r cleaning, eval=FALSE, echo=FALSE}
# Download data
winemag <- read_csv("/Users/Vanessa/Desktop/winemag-data-130k-v2.csv")

# Take out unnecessary columns
winemag <- winemag[,-c(1,10,11)]

# Take out rows for wine without the price
winemag <- winemag[complete.cases(winemag[,5]),]

# Take out rows for wine without the points 
winemag <- winemag[complete.cases(winemag[,4]),]

# Take out rows for wine without the country 
winemag <- winemag[complete.cases(winemag[,1]),]

# Take out rows for wine without the variety 
winemag <- winemag[complete.cases(winemag[,10]),]

# From the variable "title", take out the year & create a new variable "Year"
strsplit(winemag$title, "20")
str_detect(winemag$title, "20%")
library(stringr)
extract <- function(string){
  str_extract(string, "\\-*\\d+\\.*\\d*")
}

winemag <- winemag %>% 
  mutate(year = extract(title))

# Change country names to match the second dataset (countries)
data[which(data$country == "US"),]$country = "United States of America"
data[which(data$country == "England"),]$country = "United Kingdom"
```
This new database thus contains 12 variables and 101400 observations.

We then changed the format of the database into a RDA file so that people
could easily retrieve it when using our package. 
```{r RDA, eval=FALSE}
usethis::use_data(winemag, overwrite = TRUE)
```


#### Countries Dataset

To get the information about the coordinates of the countries in the World in
order to create our map, we used the geocountries function from the Geodata data
package. 

```{r countries, eval=FALSE}
# Data from Geodata package
countries <- geojson_read("/Users/Vanessa/Desktop/countries.geojson", what = "sp")
```


#### Countries and Wine reviews databases 
Create labels and color of the map 
```{r, warning=FALSE}
# Load the necessary data
load("../data/winemag.rda")
data <- winemag
load("../data/countries.rda")


# Calculate average wine quality per country
avg.quality <- data %>%
  group_by(country) %>%
  summarise(avg.quality = mean(points))

# Initialize matrix for label creation
df <- matrix(nrow = 255, ncol = 1, 0)
df <- as.data.frame(df)

df[,1] <- unique(countries$ADMIN)
colnames(df) <- c("country")
df$country <- as.character(df$country)

df <- df %>% left_join(avg.quality, by = c("country" = "country"))

# Find the number of unique countries/varieties that are present in the wine data
unique.countries <- unique(data$country)
unique.varieties <- unique(data$variety)

# Create a label based on the mots popular wine
common_wines <- data %>%
    group_by(country, variety) %>%
    count()

wine.labels <- matrix(nrow = 42, ncol = 3)
wine.labels <- as.data.frame(wine.labels)
for(i in 1:42){
    a <- common_wines %>%
        filter(country == unique.countries[i]) 
    if (is.na(a) == FALSE) {
    wine.labels[i,] <- a[which.max(a$n),]
    }
}
wine.labels <- wine.labels[-43,]

df <- df %>% 
    left_join(wine.labels, by = c("country" = "V1"))

n.wines <- data %>%
    group_by(country) %>%
    count()

df <- df %>% left_join(n.wines, by = c("country" = "country"))

countries@data$quality<- df

labels <- sprintf(
  "<strong>%s</strong><br/>%g",
  countries@data$quality$country, signif(countries@data$quality$avg.quality, digits = 3)) %>% 
  lapply(htmltools::HTML)

wine.label <- sprintf(
    "<strong>%s</strong><br/>%s",
    countries@data$quality$country, countries@data$quality$V2) %>% 
    lapply(htmltools::HTML)

# Adding label for the number of wines

number.label <- sprintf(
    "<strong>%s</strong><br/>%g",
    countries@data$quality$country, countries@data$quality$n) %>% 
    lapply(htmltools::HTML)

grouped.labels <- list(labels, wine.label, number.label)

# Creating colours for the graph
# Based on avg quality
bins <- c()
for (i in 1:5) {
    bins[i] <- quantile(countries@data$quality$avg.quality, na.rm = T, probs = 0.2*i)
}
bins.avg <- c(80,round(bins,1),93)
pal.avg <- colorBin("YlOrRd", domain = countries$df,
                bins = bins.avg)
# Based on number of wines 
bins <- c()
for (i in 1:5) {
    bins[i] <- quantile(countries@data$quality$n, na.rm = T, probs = 0.2*i)
}
bins.n <- c(0, bins, 60000)
pal.n <- colorBin("YlOrRd", domain = countries$df,
                bins = bins.n)

pal.fun <- list(pal.avg,
                pal.avg,
                pal.n)
pal <- list(pal.avg(countries@data$quality$avg.quality), 
            pal.avg(countries@data$quality$avg.quality), 
            pal.n(countries@data$quality$n))
pal.name <- c(rep("Average wine quality",2),"Amount of wines")

usethis::use_data(countries, overwrite = TRUE)
```



## Example of Basic World Map (Not interactive)

```{r}
countries <- geojson_read("data/countries.geojson", what = "sp")
class(countries)
names(countries)
#countries$ADMIN
```


Establishing connection

```{r}
m <- leaflet(countries) %>%
  setView(0, 0, 2) %>%
  addProviderTiles("MapBox", options = providerTileOptions(
    id = "mapbox.light",
    accessToken = Sys.getenv('pk.eyJ1IjoiYmFydGozaCIsImEiOiJjam81amF6ODcwODBqM3FvYTlrN2E3azlvIn0.PUtXU40gLYiECsGAMzeYiw')))
```

The data
```{r}
data <- data %>%
  filter(is.na(country) == FALSE)

data[which(data$country == "US"),]$country = "United States of America"
data[which(data$country == "England"),]$country = "United Kingdom"

avg.quality <- data %>%
  group_by(country) %>%
  summarise(avg.quality = mean(points))
```


The colouring
```{r}
df <- matrix(nrow = 255,ncol = 1, 0)
df <- as.data.frame(df)

df[,1] <- unique(countries$ADMIN)
colnames(df) <- c("country")
df$country <- as.character(df$country)

df <- df %>% left_join(avg.quality, by = c("country" = "country"))

countries@data$quality <- df

bins <- c(84,85,86,87,88,89,90,91)
pal <- colorBin("YlOrRd", domain = countries$df,
                bins = bins)

labels <- sprintf(
  "<strong>%s</strong><br/>%g",
  df$country, df$avg.quality) %>% 
  lapply(htmltools::HTML)

m %>% addPolygons(
  fillColor = ~pal(df$avg.quality),
  weight = 2,
  opacity = 1,
  color = "white",
  dashArray = "3",
  fillOpacity = 0.7,
  highlight = highlightOptions(
    weight = 5,
    color = "#666",
    dashArray = "",
    fillOpacity = 0.7,
    bringToFront = TRUE),
  label = labels,
  labelOptions = labelOptions(
    style = list("font-weight" = "normal", padding = "3px 8px"),
    textsize = "15px",
    direction = "auto")) %>%
  addLegend(pal = pal, values = ~density, opacity = 0.7, title = "Average wine quality",
            position = "bottomleft")
```
